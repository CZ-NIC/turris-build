From 2cf58b53674137d8cb9dd040a7bc31ac313cc840 Mon Sep 17 00:00:00 2001
From: Michal Hrusecky <michal.hrusecky@nic.cz>
Date: Mon, 23 Oct 2017 12:56:44 +0200
Subject: [PATCH] build: Allow to get just a subset of packages from feeds

Sometimes it is useful to get just some subset of packages from feed. This
commit changes scripts/feeds in a way that you can specify as the last optional
argument which packages should be used from the feed.

Signed-off-by: Michal Hrusecky <michal.hrusecky@nic.cz>
---
 scripts/feeds | 24 +++++++++++++++---------
 1 file changed, 15 insertions(+), 9 deletions(-)

diff --git a/scripts/feeds b/scripts/feeds
index a4dfd9e..6b2614a 100755
--- a/scripts/feeds
+++ b/scripts/feeds
@@ -54,7 +54,7 @@ sub parse_file($$) {
 		s/#.+$//;
 		$line++;
 		next unless /\S/;
-		my @line = split /\s+/, $_, 3;
+		my @line = split /\s+/, $_, 4;
 		my @src;
 
 		my $valid = 1;
@@ -73,7 +73,7 @@ sub parse_file($$) {
 			next;
 		}
 
-		push @feeds, [$line[0], $line[1], \@src];
+		push @feeds, [$line[0], $line[1], \@src, $line[3]];
 	}
 	close $fh;
 	return 1;
@@ -187,12 +187,13 @@ my %update_method = (
 # src-git: pull broken
 # src-cpy: broken if `basename $src` != $name
 
-sub update_feed_via($$$$$) {
+sub update_feed_via($$$$$$) {
 	my $type = shift;
 	my $name = shift;
 	my $src = shift;
 	my $relocate = shift;
 	my $force = shift;
+	my $filter = shift;
 
 	my $m = $update_method{$type};
 	my $localpath = "./feeds/$name";
@@ -219,6 +220,10 @@ sub update_feed_via($$$$$) {
 		}
 		system("cd '$safepath'; $update_cmd") == 0 or return 1;
 	}
+	if($filter) {
+		system("cd '$safepath'; find ./[a-zA-Z0-9]* -name Makefile -not -regex '" . $filter . "' -exec dirname \{\} \\; | xargs -d '\n' rm -rf");
+		system("cd '$safepath'; find ./[a-zA-Z0-9]* -empty -exec rmdir -p \\{\\} \\; 2> /dev/null");
+	}
 	if ($m->{'post_update'}) {
 		my $cmd = $m->{'post_update'};
 		system("cd '$safepath'; $cmd") == 0 or return 1;
@@ -741,13 +746,14 @@ sub uninstall {
 	return 0;
 }
 
-sub update_feed($$$$$)
+sub update_feed($$$$$$)
 {
 	my $type=shift;
 	my $name=shift;
 	my $src=shift;
 	my $perform_update=shift;
 	my $force_update=shift;
+	my $filter=shift;
 	my $force_relocate=update_location( $name, "@$src" );
 	my $rv=0;
 
@@ -762,7 +768,7 @@ sub update_feed($$$$$)
 		my $failed = 1;
 		foreach my $feedsrc (@$src) {
 			warn "Updating feed '$name' from '$feedsrc' ...\n";
-			if (update_feed_via($type, $name, $feedsrc, $force_relocate, $force_update) != 0) {
+			if (update_feed_via($type, $name, $feedsrc, $force_relocate, $force_update, $filter) != 0) {
 				if ($force_update) {
 					$rv=1;
 					$failed=0;
@@ -814,17 +820,17 @@ sub update {
 
 	if ( ($#ARGV == -1) or $opts{a}) {
 		foreach my $feed (@feeds) {
-			my ($type, $name, $src) = @$feed;
-			update_feed($type, $name, $src, $perform_update, $opts{f}) == 0 or $failed=1;
+			my ($type, $name, $src, $filter) = @$feed;
+			update_feed($type, $name, $src, $perform_update, $opts{f}, $filter) == 0 or $failed=1;
 		}
 	} else {
 		while ($feed_name = shift @ARGV) {
 			foreach my $feed (@feeds) {
-				my ($type, $name, $src) = @$feed;
+				my ($type, $name, $src, $filter) = @$feed;
 				if($feed_name ne $name) {
 					next;
 				}
-				update_feed($type, $name, $src, $perform_update, $opts{f}) == 0 or $failed=1;
+				update_feed($type, $name, $src, $perform_update, $opts{f}, $filter) == 0 or $failed=1;
 			}
 		}
 	}
-- 
2.22.0

